<div class="px-4 py-6">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Buscar Vehículo</h1>
    <p class="mt-2 text-sm text-gray-600">
      Consulte el historial de evaluaciones de un vehículo
    </p>
  </div>

  <!-- Search Form -->
  <div class="max-w-2xl mb-8">
    <app-alert *ngIf="errorMessage()" variant="error" (closed)="errorMessage.set(null)">
      {{ errorMessage() }}
    </app-alert>

    <div class="card">
      <label for="matricula" class="block text-sm font-medium text-gray-700 mb-2">
        Matrícula del Vehículo
      </label>
      <div class="flex gap-2">
        <input
          id="matricula"
          type="text"
          [(ngModel)]="matriculaSearch"
          (keyup.enter)="buscarVehiculo()"
          placeholder="ABC123"
          class="input-field flex-1"
          maxlength="12">
        <button
          type="button"
          (click)="buscarVehiculo()"
          [disabled]="searching() || !matriculaSearch.trim()"
          class="btn-primary">
          <span *ngIf="!searching()">Buscar</span>
          <span *ngIf="searching()">Buscando...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <app-loading-spinner *ngIf="searching()" message="Buscando vehículo..."></app-loading-spinner>

  <!-- Vehicle Info -->
  <div *ngIf="vehiculo() && !searching()" class="space-y-6">
    <!-- Vehicle Card -->
    <div class="card">
      <div class="flex items-start justify-between">
        <div>
          <h2 class="text-2xl font-bold text-gray-900">{{ vehiculo()!.matricula }}</h2>
          <p class="mt-1 text-lg text-gray-600" *ngIf="vehiculo()!.marca || vehiculo()!.modelo">
            {{ vehiculo()!.marca }} {{ vehiculo()!.modelo }}
            <span *ngIf="vehiculo()!.anio">({{ vehiculo()!.anio }})</span>
          </p>
          <p class="mt-2 text-sm text-gray-500">
            Propietario: {{ vehiculo()!.propietario.nombre }}
          </p>
        </div>
        <app-badge [color]="getEstadoColor(vehiculo()!.estadoVehiculo.codigo)">
          {{ vehiculo()!.estadoVehiculo.nombre }}
        </app-badge>
      </div>
    </div>

    <!-- Tabs -->
    <div class="card">
      <div class="border-b border-gray-200 mb-4">
        <nav class="flex gap-4">
          <button
            type="button"
            (click)="setActiveTab('evaluaciones')"
            [class.border-blue-500]="activeTab() === 'evaluaciones'"
            [class.text-blue-600]="activeTab() === 'evaluaciones'"
            [class.border-transparent]="activeTab() !== 'evaluaciones'"
            [class.text-gray-500]="activeTab() !== 'evaluaciones'"
            class="py-2 px-1 border-b-2 font-medium text-sm transition-colors hover:text-blue-600">
            Historial de Evaluaciones
          </button>
          <button
            type="button"
            (click)="setActiveTab('turnos')"
            [class.border-blue-500]="activeTab() === 'turnos'"
            [class.text-blue-600]="activeTab() === 'turnos'"
            [class.border-transparent]="activeTab() !== 'turnos'"
            [class.text-gray-500]="activeTab() !== 'turnos'"
            class="py-2 px-1 border-b-2 font-medium text-sm transition-colors hover:text-blue-600">
            Historial de Turnos
          </button>
        </nav>
      </div>

      <!-- Tab Content: Evaluaciones -->
      <div *ngIf="activeTab() === 'evaluaciones'">
        <app-loading-spinner *ngIf="loadingEvaluaciones()" [size]="32" message="Cargando evaluaciones..."></app-loading-spinner>

      <div *ngIf="!loadingEvaluaciones() && evaluaciones().length === 0" class="text-center py-8 text-gray-500">
        No hay evaluaciones registradas para este vehículo.
      </div>

      <div *ngIf="!loadingEvaluaciones() && evaluaciones().length > 0" class="space-y-4">
        <div *ngFor="let evaluacion of evaluaciones()" 
             class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-sm font-medium text-gray-900">
                  {{ formatDate(evaluacion.fecha) }}
                </span>
                <app-badge [color]="getResultadoColor(evaluacion.resultado.codigo)">
                  {{ evaluacion.resultado.nombre }}
                </app-badge>
              </div>
              <div class="flex items-center gap-4 text-sm text-gray-600">
                <span class="font-semibold">
                  Puntaje Total: {{ evaluacion.puntajeTotal }}/100
                </span>
              </div>
            </div>
            <button
              type="button"
              (click)="toggleDetalles(evaluacion.id)"
              class="text-blue-600 hover:text-blue-800 text-sm font-medium">
              {{ detallesExpandidos().has(evaluacion.id) ? 'Ocultar' : 'Ver Detalles' }}
            </button>
          </div>

          <!-- Detalles Expandidos -->
          <div *ngIf="detallesExpandidos().has(evaluacion.id)" class="mt-4 pt-4 border-t border-gray-200">
            <h4 class="text-sm font-semibold text-gray-900 mb-3">Detalles de Chequeos:</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div *ngFor="let detalle of evaluacion.detalles" 
                   class="bg-gray-50 rounded-lg p-3">
                <div class="flex justify-between items-start mb-1">
                  <span class="text-sm font-medium text-gray-900">
                    {{ detalle.chequeo.nombre }}
                  </span>
                  <span class="text-sm font-bold"
                        [class.text-green-600]="detalle.puntaje >= 8"
                        [class.text-yellow-600]="detalle.puntaje >= 5 && detalle.puntaje < 8"
                        [class.text-red-600]="detalle.puntaje < 5">
                    {{ detalle.puntaje }}/10
                  </span>
                </div>
                <p *ngIf="detalle.observacion" class="text-xs text-gray-600 mt-1">
                  {{ detalle.observacion }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div *ngIf="paginationMeta()" class="flex items-center justify-between pt-4 border-t border-gray-200">
          <span class="text-sm text-gray-700">
            Total: {{ paginationMeta()!.total }} evaluaciones
          </span>
          <div class="flex gap-2">
            <button
              type="button"
              (click)="previousPage()"
              [disabled]="currentPage() === 1"
              class="btn-secondary text-sm">
              Anterior
            </button>
            <span class="px-4 py-2 text-sm text-gray-700">
              Página {{ currentPage() }}
            </span>
            <button
              type="button"
              (click)="nextPage()"
              [disabled]="!paginationMeta()!.hasNext"
              class="btn-secondary text-sm">
              Siguiente
            </button>
          </div>
        </div>
      </div>
      </div>

      <!-- Tab Content: Turnos -->
      <div *ngIf="activeTab() === 'turnos'">
        <app-loading-spinner *ngIf="loadingTurnos()" [size]="32" message="Cargando turnos..."></app-loading-spinner>

        <div *ngIf="!loadingTurnos() && turnos().length === 0" class="text-center py-8 text-gray-500">
          No hay turnos registrados para este vehículo.
        </div>

        <div *ngIf="!loadingTurnos() && turnos().length > 0" class="space-y-4">
          <div *ngFor="let turno of turnos()" 
               class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-sm font-medium text-gray-900">
                    {{ formatTurnoDate(turno.fechaHora) }}
                  </span>
                  <app-badge [color]="getEstadoTurnoColor(turno.estadoTurno.codigo)">
                    {{ turno.estadoTurno.nombre }}
                  </app-badge>
                </div>
                <div class="text-sm text-gray-600 space-y-1">
                  <p><span class="font-semibold">Centro:</span> {{ turno.centro.nombre }}</p>
                  <p><span class="font-semibold">Dirección:</span> {{ turno.centro.direccion }}</p>
                  <p *ngIf="turno.creadoPorUsuario" class="text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200">
                    <span class="font-semibold">Reservado por:</span> {{ turno.creadoPorUsuario.nombre }}
                    <span class="block text-gray-400">{{ turno.creadoPorUsuario.email }}</span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
